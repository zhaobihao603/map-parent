<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.imap.cloud.common.dao.map.MapLayerRenderMapper" >
    <resultMap id="BaseResultMap" type="com.imap.cloud.common.entity.map.MapLayerRender" >
    	<id column="id" property="id" jdbcType="CHAR"/>
        <result column="layerId" property="layerId" jdbcType="CHAR" />
        <result column="showId" property="showId" jdbcType="CHAR" />
        <result column="valueFields" property="valueFields" jdbcType="VARCHAR" />
        <result column="renderStyle" property="renderStyle" jdbcType="LONGVARCHAR" />
    </resultMap>
    <resultMap id="ResultMapWithEntity" type="com.imap.cloud.common.entity.map.MapLayerRender">
    	<association property="layer"  column="layerId" select="getLayerById">
  		</association>
  		<association property="showType"  column="showId" select="getShowTypeById">
  		</association>
    </resultMap>
    
    <select id="getLayerById" parameterType="java.lang.String" resultType="com.imap.cloud.common.entity.map.MapLayer">
    	select * from map_layer where id=#{id,jdbcType=CHAR}
    </select>

	<select id="getShowTypeById" parameterType="java.lang.String" resultType="com.imap.cloud.common.entity.system.DictionaryItem">
    	select * from common_datadir_item where id=#{id,jdbcType=CHAR}
    </select>

    <sql id="Base_Column_List" >
        layerId,showId,valueFields,renderStyle
    </sql>

    <select id="selectByPk" resultMap="ResultMapWithEntity">
        select 
        <include refid="Base_Column_List" />
        from map_layer_render
        where layerId = #{layerId,jdbcType=CHAR}
        and	showId = #{showId,jdbcType=CHAR}
        and valueFields = #{valueFields,jdbcType=CHAR}
    </select>
    
	<!-- 自动获取主键 -->
    <insert id="insert" parameterType="com.imap.cloud.common.entity.map.MapLayerRender" >
    	<selectKey keyProperty="id" resultType="String" order="BEFORE">  
			select  replace(uuid(),'-','')   from dual  
		</selectKey>
        insert into map_layer_render (id,layerId,showId,valueFields,renderStyle)
        values (#{id,jdbcType=CHAR},#{layerId,jdbcType=CHAR}, #{showId,jdbcType=CHAR}, 
        	#{valueFields,jdbcType=VARCHAR}, #{renderStyle,jdbcType=LONGVARCHAR})
    </insert>

    <update id="updateByPkSelective" parameterType="com.imap.cloud.common.entity.map.MapLayerRender" >
        update map_layer_render
        set renderStyle = #{renderStyle,jdbcType=LONGVARCHAR}
        where layerId = #{layerId,jdbcType=CHAR}
       and	showId = #{showId,jdbcType=CHAR}
       and valueFields = #{valueFields,jdbcType=VARCHAR}
    </update>
	
    <delete id="deleteByPk">
        delete from map_layer_render
        where layerId = #{layerId,jdbcType=CHAR}
       and	showId = #{showId,jdbcType=CHAR}
       and valueFields = #{valueFields,jdbcType=VARCHAR}
    </delete>
	<select id="selectColumns" resultType="String">
		SELECT DISTINCT(COLUMN_NAME)
		FROM information_schema.`COLUMNS`  
		WHERE TABLE_SCHEMA=#{usedDatabaseName,jdbcType=VARCHAR} 
		and TABLE_NAME = 'map_layer_item'
		<foreach collection="columnsType" item="columnsType" open="and DATA_TYPE IN (" close=")" separator="," >
            #{columnsType}
        </foreach>
	</select>
	<select id="selectByValueFields" resultType="Map" statementType="STATEMENT">
		select count(*) count,
		<foreach collection="valueFields" item="valueField" open="" close="" separator=",">
			${valueField}
		</foreach>
		from map_layer_item where layerId='${layerId}'
		group by 
		<foreach collection="valueFields" item="valueField" open="" close="" separator=",">
			${valueField}
		</foreach>
	</select>
</mapper>